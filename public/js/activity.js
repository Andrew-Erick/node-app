$(function(){
  var json=[{
    "number":"1", 
    "id":1001,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1002,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1003,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1004,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1005,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1006,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1007,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1008,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1009,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1010,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1011,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1012,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1013,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1014,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1015,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1016,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1017,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1018,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1019,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  },{
    "number":"1", 
    "id":1020,
    "level":"level", 
    "upper_activity":"upper_activity", 
    "activity_number":"activity_number", 
    "activity":"activity", 
    "activity_description":"activity_description",
    "type":"type", 
    "input":"input", 
    "output":"output", 
    "task":"task", 
    "executor":"executor", 
    "stage":"stage", 
    "line":"line", 
    "tool":"tool", 
    "method":"method",
    "action":['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('')
  }]
  var $table=$('#activityTable');
  var $remove=$('#activityRemove');
  var $toolbar=$('#activityToolbar');
  var $add=$('#activityAdd');
  var $form=$('#activityForm');
  var $modal=$('#activityModal');
  function activityActionFormatter(value,row,index){
    return ['<span class="edit" title="edit">','<i class="oi oi-pencil"></i></span>','&npsq;','<span class="" title="remove">','<i class="oi oi-trash"></i></span>'].join(',');
  };
  window.activityActionEvents = {
    'click .edit': function (e, value, row, index) {
      e.preventDefault();
        $form.attr({'data-add':'false','data-index':index});
        $form.find('[name]').each(function(i,item){
          var name=$(item).attr('name');
          $(item).val(row[name]);
        });
    },
    'click .remove': function (e, value, row, index) {
      e.preventDefault();
        $table.bootstrapTable('remove', {
            field: 'id',
            values: [row.id]
        });
    }
  };
  $table.on('check.bs.table uncheck.bs.table ' +
        'check-all.bs.table uncheck-all.bs.table', function () {
    $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);

    // save your data, here just save the current page
    selections = getIdSelections();
    // push or splice the selections if you want to save all data selections
  });
  $remove.click(function(){
    var ids=getIdSelections();
    if(ids.length>0){
      $table.bootstrapTable('remove',{
        field:'id',
        values:ids
      })
      $remove.prop('disabled',true);
      
    }
  })
 function getIdSelections() {
      return $.map($table.bootstrapTable('getSelections'), function (row) {
          return row.id
      });
  }
  $toolbar.find('select').change(function(){
    $table.bootstrapTable({
      exportDataType:$(this).val()
    })
  })
  $table.bootstrapTable('load',json); 

  // func add & edit
  // add
  $add.click(function(){
    $form.attr("data-add",true);
    $form.removeAttr("data-index"); 
  });

  $modal.on('hidden.bs.modal', function() {
    $form.formValidation('resetForm', true);
  });

  // form validate
  $form.formValidation({
    framework:'bootstrap',
    excluded:':disabled',
    icon:{
      valid:'glyphicon glyphicon-ok',
      invalid:'glyphicon glyphicon-remove',
      validating:'glyphicon glyphicon-refresh',
    },
    fields:{
      id:{
        validators:{
          notEmpty:{
            message:'the ID is required'
          },
          stringLength:{
            min:1,
            max:6,
            message:'The ID must be more than 1 and less than 6 characters long'
          },
          regexp:{
            regexp:/^[0-9]+$/,
            message:'The ID can only consist of number'
          }
        }
      },
      level:{

      }
    }
  }).on('success.form.fv',function(e){
      // Prevent form submission
      e.preventDefault();
      var $form=$(e.target);
      var data=$form.serializeObject();
      data.action=['<span class="edit" title="edit" data-toggle="modal" data-target="#activityModal">','<i class="oi oi-pencil"></i></span>','&nbsp;&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('');
      // 表单reset
      var add=$form.attr("data-add");
      var index=$form.attr("data-index");
      if(add=="true"){
        $table.bootstrapTable('insertRow',{index:1,row:data});
      }else{
        $table.bootstrapTable('updateRow',{index:index,row:data});       
      }
      $modal.modal('hide');
      $form.formValidation('resetForm', true);
    })

})