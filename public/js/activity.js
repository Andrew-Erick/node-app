 // var json=[{
  //   "id":3,
  //   "level":3, 
  //   "upper_activity":2, 
  //   "activity_number":"", 
  //   "activity":"确认系统需求 Validate  System Requirement", 
  //   "activity_description":"根据企业及产品项目特点，捕获对企业决策、产品开发存在预期期望、约束、限制等的利益攸关方。",
  //   "type":1, 
  //   "input":"1）利益攸关方管理数据库；2）利益攸关方类型定义；3）利益攸关方优先级评估模型及方法。", 
  //   "output":"D1.1.02.01 利益攸关方识别报告 Stakeholder Identification Report", 
  //   "task":"任务基本要求：1)根据企业和产品实际情况，编制利益攸关方检查单，以便确保完整识别利益攸关方；2)开展利益攸关方识别定义；3)对所有利益攸关方进行分类；4)开展利益攸关方优先级定义；5)绘制利益攸关方关系图；6)编制利益攸关方识别报告。", 
  //   "executor":1, 
  //   "stage":"G2", 
  //   // "line":"line", 
  //   "tool":"分析、头脑风暴、既有经验、检查单、专家挖掘等", 
  //   "method":"暂无推荐"
  // },{
  //   "id":4,
  //   "level":3, 
  //   "upper_activity":2, 
  //   "activity_number":"", 
  //   "activity":"识别市场需求和目标 Identify Market Requirement and Objective", 
  //   "activity_description":"通过调研分析等手段明确目前及未来市场的整体形势、需求、趋势、空间等内容，在此基础上结合公司发展战略和现实情况，确定企业开发产品的预期目标市场，进而明确市场需求与目标。",
  //   "type":1, 
  //   "input":"D1.1.02.01 利益攸关方识别报告 Stakeholder Identification Report", 
  //   "output":"D1.1.02.02 市场需求分析报告 MRA", 
  //   "task":"任务基本要求：1)宏观分析当前及未来市场发展趋势；2)分析新技术发展对未来市场的影响；3)分析宏观政策等可能会影响市场发展因素；4)分析竞争产品的基本情况；5)分析公司发展战略和约束条件；6)确定公司目标市场；7)详细分析产品目标市场，并针对性定义市场需求与目标，编制市场需求分析报告。", 
  //   "executor":1, 
  //   "stage":"G2", 
  //   "line":"line", 
  //   "tool":"调研、问卷、分析等", 
  //   "method":"暂无推荐"
  // },{
  //   "id":5,
  //   "level":3, 
  //   "upper_activity":2, 
  //   "activity_number":"", 
  //   "activity":"定义民机产品系统功能 Define Aircraft System Function", 
  //   "activity_description":"基于民机产品系统研制需求和目标，结合民机产品系统功能定义，定义基本性能指标，并开发民机产品系统的架构，其中包括飞机顶层架构设计和其他民机产品系统部分的设计，并对经济性进行分析，使用新技术的实施路径进行规划，对相关研制过程所需使能过程进行规划，从而支持可行性研究结论",
  //   "type":1, 
  //   "input":"D1.1.02.02 市场需求分析报告 MRA", 
  //   "output":"D1.1.01.01 民机产品系统功能定义#1 Aircraft System Function Definition#1", 
  //   "task":"任务基本要求：1)根据民机产品系统研制需求和目标和民机产品系统功能定义中设计需求和功能定义内容，进行民机产品系统的顶层综合设计工作；2)从多个备选方案中，完成权衡研究，明确最优的民机产品系统方案；3)针对新材料、新工艺和新技术，明确技术实施路径，形成实施规划；4)形成技术、经济可行性报告；5)制定使能系统方案，包括设计手段、工具环境、试验、试飞和生产条件建设规划。",
  //   "executor":2, 
  //   "stage":"G2", 
  //   "line":"line", 
  //   "tool":"CONCEPT DESCRIPTION SHEET等", 
  //   "method":"暂无推荐"
  // },{
  //   "id":6,
  //   "level":3, 
  //   "upper_activity":2, 
  //   "activity_number":"", 
  //   "activity":"捕获用户要求 Capture Customer Needs", 
  //   "activity_description":"面向所标识到的所有利于攸关方，根据市场需求与目标针对性地通过调研、电话咨询、专家挖掘、经验借鉴、问卷等形式捕获潜在用户对民机产品系统的要求，作为后期制定民机产品系统商业需求的原始依据之一。",
  //   "type":1, 
  //   "input":"D1.1.01.01 利益攸关方识别报告；D1.1.02.02 市场需求分析报告 MRA。", 
  //   "output":"D1.1.02.03 用户要求报告 Customer Needs Report", 
  //   "task":"任务基本要求：1)根据利益攸关方优先级设置，对用户进行分组和优先级划分；2)捕获用户要求，并形成原始用户要求记录；3)开展用户要求分析工作，归类总结用户要求，编制用户要求报告；4)建立分析后的用户要求报告与原始用户要求之间的追溯关系；", 
  //   "executor":3, 
  //   "stage":"G3", 
  //   "line":"line", 
  //   "tool":"暂无推荐", 
  //   "method":"暂无推荐"
  // },{
  //   "id":11,
  //   "level":3, 
  //   "upper_activity":11, 
  //   "activity_number":"", 
  //   "activity":"开发民机产品系统架构 Develop Aircraft System Architecture", 
  //   "activity_description":"通过分析未来市场需求及其初步民机产品系统功能分析结果，开发初步的民机产品系统的架构。",
  //   "type":1, 
  //   "input":"D1.1.02.02 市场需求分析报告 MRA；D1.1.01.01 民机产品系统功能定义#1 Aircraft System Function Definition#1", 
  //   "output":"D1.2.03.01 民机产品系统架构#1 Aircraft System Architecture#1", 
  //   "task":"任务基本要求：根据市场分析报告，结合民机产品系统功能定义，初步定义基本技术指标，形成义民机产品系统一个或多个备选方案。应包括：1)飞机的系统分解组成；2)总体参数、总体布局和主要性能指标，包括飞机布局形式、座级、航程、环境、速度、发动机类型和推力等级；3)可能采用的新材料和新技术；4)初步对经济性进行估算，提出经济性目标；5)对应的其他领域顶层初步方案，具体包括：对应的培训系统初步方案、对应的支持系统方案、对应的设施系统方案（机场、航线等)。", 
  //   "executor":4, 
  //   "stage":"G2", 
  //   "line":"line", 
  //   "tool":"暂无推荐", 
  //   "method":"暂无推荐"
  // },{
  //   "id":12,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"定义民机产品系统架构 Define Aircraft System Architecture ", 
  //   "activity_description":"基于民机产品系统研制需求和目标，结合民机产品系统功能定义，定义基本性能指标，并开发民机产品系统的架构，其中包括飞机顶层架构设计和其他民机产品系统部分的设计，并对经济性进行分析，使用新技术的实施路径进行规划，对相关研制过程所需使能过程进行规划，从而支持可行性研究结论。",
  //   "type":1, 
  //   "input":"D1.1.02.07 民机产品系统研制需求和目标 Aircraft System Development Requirement and Objective；D1.2.03.01 民机产品系统架构#1 Aircraft System Architecture#1。", 
  //   "output":"D1.2.03.02 民机产品系统架构#2 Aircraft System Architecture#2", 
  //   "task":"任务基本要求：1)根据民机产品系统研制需求和目标和民机产品系统功能定义中设计需求和功能定义内容，进行民机产品系统的顶层综合设计工作；2)从多个备选方案中，完成权衡研究，明确最优的民机产品系统方案；3)针对新材料、新工艺和新技术，明确技术实施路径，形成实施规划；4)形成技术、经济可行性报告；5)制定使能系统方案，包括设计手段、工具环境、试验、试飞和生产条件建设规划。", 
  //   "executor":4, 
  //   "stage":"G3", 
  //   "line":"line", 
  //   "tool":"各类架构设计方法、权衡分析方法等", 
  //   "method":"暂无推荐"
  // },{
  //   "id":15,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"定义系统功能 Define System Function", 
  //   "activity_description":"基于飞机级功能架构中分配到当前系统的功能，结合当前系统的顶层需求及特点，定义系统在不同工作模式下的功能，形成系统的功能列表/清单。",
  //   "type":2, 
  //   "input":"D2.1.01.02 飞机功能架构描述 Aircraft Function Architecture Description；D2.3.01.04 系统顶层需求文件#2 Top Level System Requirement#2。", 
  //   "output":"D3.1.01.01 系统功能定义 System Function Definition", 
  //   "task":"任务基本要求：1)进行系统功能的识别；2)进行系统功能的定义。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"IDEF0、功能流等", 
  //   "method":"SysML、泳道图"
  // },{
  //   "id":16,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"分析系统功能 Analysis System Function ", 
  //   "activity_description":"基于功能定义中形成的基本功能，分析飞机运行过程(pre-flight, take-off, flight, post-flight)中的活动以及与周围环境的交互过程，将基本功能分解为若干相互独立的子功能，并分析子功能之间的逻辑关系和功能接口。",
  //   "type":2, 
  //   "input":"D3.1.01.01 系统功能定义 System Function Definition；D2.3.02.03 飞机功能接口控制文件#2 AFICD#2。", 
  //   "output":"D3.1.01.01 系统功能架构描述 System Function Architecture Description；D3.1.02.02  系统级功能ICD#1 SFICD#1。", 
  //   "task":"任务基本要求：1)进行系统级功能的分解；2)进行系统级功能的分配；3)完成系统级功能的逻辑架构；4)定义系统级功能接口控制文件。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"IDEF0、功能流等", 
  //   "method":"EA、IBM Rational Raphsody等"
  // },{
  //   "id":17,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"捕获系统需求 Capture System Requirements", 
  //   "activity_description":"需求捕获的目的是挖掘并且与相关方认可所有的需要和限制，以确保这些内容已经在产品定义过程中予以考虑。目标是确保所有对飞机感兴趣的人都能够表达各自的需求。在捕获需求时，还要记录需求的Rationale、Source、以及来自的相关方。",
  //   "type":2, 
  //   "input":"D3.1.01.01 系统功能架构描述 System Function Architecture Description；D2.3.02.04 系统顶层需求文件#2 Top Level System Requirement#2；D3.1.20.01 系统FHA SFHA；D2.2.05.03 驾驶舱人机界面功能分配说明 Crew Interface function Allocation。", 
  //   "output":"D3.1.02.01 系统需求文件#1 System Requirements Document#1", 
  //   "task":"任务基本要求：1)根据系统级功能分析，捕获功能性需求；2)根据系统级功能危害性分析，捕获安全性需求；3)根据型号合格审定基础以及相关的运行要求，捕获系统级适航相关需求；4)定义其他系统的非功能性需求；5)建立到系统顶层需求的链接关系。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"", 
  //   "method":""
  // },{
  //   "id":18,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"确认系统需求 Validate  System Requirement", 
  //   "activity_description":"明确定义系统级确认的目的、原则、角色及职责、确认活动交付物，定义了详细的需求确认流程，包括需求执行人分配、确认严苛级别判定准则、确认方法分配、确认结果签署评审等活动。",
  //   "type":2, 
  //   "input":"D3.1.02.01 系统需求文件#1 System Requirements Document#1；D3.1.02.02 系统级功能ICD#1 SFICD#1;", 
  //   "output":"D3.3.02.02 系统需求确认总结报告 System Requirements Validation Summary Report；D3.3.02.01  系统需求文件#2 System Requirements Document#2；D3.3.02.03  系统级功能ICD#2 SFICD#2。", 
  //   "task":"任务基本要求：1)分配需求确认执行人；2)根据确认严苛级别定义确认方法；3)描述需求确认方案；4)执行确认活动并记录证据；5)根据结果定义确认结论；6)设置需求确认状态；7)签署评审需求确认结果；8)发布确认矩阵并建立基线。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"", 
  //   "method":""
  // },{
  //   "id":19,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"进行系统功能危险性评估 Perform System Functional Hazard Assessment", 
  //   "activity_description":"在飞机设计过程中，将飞机功能分配到系统后，综合了多重飞机功能的每个系统必须进行SFHA。SFHA 是以系统的功能为研究对象，识别影响飞机持续、安全飞行的系统功能失效，并根据该功能失效对飞机、机组或乘员影响的严重程度进行分类。",
  //   "type":2, 
  //   "input":"D3.1.01.01 系统功能架构描述 System Function Architecture  Description；D2.3.02.04 系统顶层需求文件#2 Top Level System Requirement#2；D2.3.20.01 初步飞机安全性评估 PASA。", 
  //   "output":"D3.1.20.01 系统FHA SFHA", 
  //   "task":"任务基本要求：1)确定与分析层次相关的所有功能（包括内部功能和交互功能)；2)确定并说明与这些功能相关的失效状态，考虑在正常和恶化环境下的单一和多重失效；3)确定失效状态的影响；4)根据失效状态对飞机或人员的影响对其进行分类（灾难性的，危险的，较大的，轻微的和没有安全性影响的)；5)给出用于证明失效状态影响分类所要求的支撑材料；6)提出用于验证失效状态满足安全性需求的符合性验证方法。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"", 
  //   "method":""
  // },{
  //   "id":20,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"分解和分配需求 Decompose& Allocate Requirements", 
  //   "activity_description":"根据所定义的系统级需求，开展系统物理架构设计工作，在此过程中优化权衡确定最优的系统物理架构，在确定系统物理架构过程中会产生具体的衍生需求，功能需求也被进一步的细化分解，并将所形成的系统级设备统顶层需求分配给具体的物理系统。",
  //   "type":2, 
  //   "input":"D3.3.02.01 系统需求文件#2 System Requirements Document#2；D3.3.03.02 系统描述文件#2 System Description Document#1；D3.3.20.01 初步系统安全性评估 PSSA。", 
  //   "output":"D3.1.02.03 设备顶层需求文件#1 Top Level Equipment Requirements Report#1", 
  //   "task":"任务基本要求：1)根据系统架构设计工作，将系统级需求细化分解为具体设备的顶层需求；2)捕获定义给定架构下所产生的衍生需求，将衍生需求分配至具体的设备；3)在需求管理数据库中编写需求，填写需求分配关系等属性；4)编制设备顶层需求。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"", 
  //   "method":""
  // },{
  //   "id":21,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"确认设备顶层需求 Validate Top Level Equipment Requirements", 
  //   "activity_description":"针对系统级设备顶层需求文件，根据系统级需求确认计划，填写初始确认矩阵，开展系统级设备顶层需求的确认活动，并记录捕获确认证据。",
  //   "type":2, 
  //   "input":"D3.1.02.03 设备顶层需求文件#1 Top Level Equipment Requirements Report#1", 
  //   "output":"D3.3.02.05 设备顶层需求确认总结报告 Top Level Equipment Requirements Validation Summary；D3.3.02.04 设备顶层需求文件#2 Top Level Equipment Requirements Report#2。", 
  //   "task":"任务基本要求：1)分配需求确认执行人；2)根据确认严苛级别定义确认方法；3)描述需求确认方案；4)执行确认活动并记录证据；5)根据结果定义确认结论；6)设置需求确认状态；7)签署评审需求确认结果；8)发布确认矩阵并建立基线。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"", 
  //   "method":""
  // },{
  //   "id":22,
  //   "level":3, 
  //   "upper_activity":14, 
  //   "activity_number":"", 
  //   "activity":"进行系统设计 Perform System Synethies", 
  //   "activity_description":"根据系统级需求和功能分析结果，进行各系统的设计工作，形成系统架构，用于系统需求的分配和初步系统安全性评估等工作。",
  //   "type":2, 
  //   "input":"D3.3.02.01 系统需求文件#2 System Requirements Document#2；D3.3.02.03 系统级功能ICD#2 SFICD#2；D3.1.01.01 系统功能架构描述 System Function Architecture Description；D2.3.03.01 飞机设计描述# 2 ADD#2；D3.1.05.01 人机界面设计要求 Crew Interface requirement。", 
  //   "output":"D3.2.03.01 系统描述文件#1 System Description Document#1；D3.2.03.02  物理ICD#1 PICD #1。", 
  //   "task":"任务基本要求：根据系统需求文件，结合系统功能分析，完成系统方案，形成系统设计描述文件，包括：1)根据系统需求、功能分析结果和ICD输入，进行系统架构设计工作，完成多个备选架构的设计；2)进行备选架构的选择，架构选择过程的记录完善；3)识别架构产生的衍生需求。", 
  //   "executor":5, 
  //   "stage":"G6", 
  //   "line":"line", 
  //   "tool":"", 
  //   "method":""
  // }]
  var $table=$('#activityTable');
  var $remove=$('#activityRemove');
  var $toolbar=$('#activityToolbar');
  var $add=$('#activityAdd');
  var $form=$('#activityForm');
  var $modal=$('#activityModal');
  window.activityFormatter=function(value,row,index){
    return ['<span class="add" title="add" data-toggle="modal" data-target='+'#'+$modal.attr("id")+'>','<i class="oi oi-plus"></i></span>','&nbsp;','<span class="edit" title="edit" data-toggle="modal" data-target='+'#'+$modal.attr("id")+'>','<i class="oi oi-pencil"></i></span>','&nbsp;','<span class="remove" title="remove">','<i class="oi oi-trash"></i></span>'].join('');
  };
  window.stageFormatter=function(value,row,index){
    return value==undefined?"":("<a target='_blanket' href='/preview/detail?id="+value._id+"'>"+value.name+"</a>");
  };
  window.typeFormatter=function(value,row,index){
    var typeValues=["飞机级","系统级","设备级"];
    return (value==null||value=="")?"":typeValues[value-1];
  };
  window.executorFormatter=function(value,row,index){
    var executorValues=["市场研究","系统工程","市场和销售","总体气动","各系统工作包"];
    return (value==null||value=="")?"":executorValues[value-1];
  };
  window.activityActionEvents = {
    'click .edit': function (e, value, row, index) {
      e.preventDefault();
      $form.attr({'data-add':'false','data-index':index});
      console.log(row);
      $form.find('[name]').each(function(i,item){
        var name=$(item).attr('name');
        if(name=="stage"){
          $(item).val(row[name]==undefined?null:row[name]._id)
        }else{
          $(item).val(row[name]);
          
        }
      });
    },
    'click .remove': function (e, value, row, index) {
      e.preventDefault();
      deleteItem([row._id],function(){
        $table.bootstrapTable('remove', {
            field: 'id',
            values: [row.id]
        });     
      })
    },
    'click .add': function (e, value, row, index) {
      e.preventDefault();
      // e.stopPropagation();
      $form.attr({'data-add':'true','data-index':index});
      //
      $form.find("input[name=pid]").val(row["_id"]);
      $form.find("input[name=level]").val(parseInt(row["level"])+1);
    }
  };
  $table.on('check.bs.table uncheck.bs.table ' +
        'check-all.bs.table uncheck-all.bs.table', function () {
    $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);

    // save your data, here just save the current page
    // push or splice the selections if you want to save all data selections
  });
  $remove.click(function(){
    var data=getIdSelections();
    if(data.ids.length>0){
      deleteItem(data.rowids,function(){
        $table.bootstrapTable('remove',{
          field:'_id',
          values:data.ids
        })
        $remove.prop('disabled',true);   
      })     
    }
  });

  function deleteItem(ids,next){
    $.ajax({
      type:"DELETE",
      url:"/activity/delete",
      data:{
        ids:ids
      },
      success:function(){
        next()
      }
    })
  }

  function getIdSelections() {
      var rowids=$.map($table.bootstrapTable('getSelections'), function (row) {
          return row._id
      });
      var ids=$.map($table.bootstrapTable('getSelections'), function (row) {
          return row._id
      });
      return {rowids:rowids,ids:ids};
  }
  $toolbar.find('select').change(function(){
    $table.bootstrapTable({
      exportDataType:$(this).val()
    })
  })
  // $table.bootstrapTable('load',json); 
  // func add & edit
  // add
  $add.click(function(){
    $form.attr("data-add",true);
    $form.removeAttr("data-index"); 
  });

  $modal.on('hidden.bs.modal', function() {
    $form.formValidation('resetForm', true);
  });
   $table.bootstrapTable({
      url:'/activity/data',
      pagination: true,
      treeView: true,
      treeId:'_id',
      treeField: "activity",
      treeRootLevel: 1,
      clickToSelect: false
      //collapseIcon: "glyphicon glyphicon-triangle-right",//折叠样式
      //expandIcon: "glyphicon glyphicon-triangle-bottom"//展开样式
  });
  // form validate
  $form.formValidation({
    framework:'bootstrap',
    excluded:':disabled',
    icon:{
      valid:'glyphicon glyphicon-ok',
      invalid:'glyphicon glyphicon-remove',
      validating:'glyphicon glyphicon-refresh',
    },
    fields:{
      id:{
        validators:{
          notEmpty:{
            message:'the ID is required'
          },
          stringLength:{
            min:1,
            max:6,
            message:'The ID must be more than 1 and less than 6 characters long'
          },
          regexp:{
            regexp:/^[0-9]+$/,
            message:'The ID can only consist of number'
          }
        }
      },
      _id:{},
      pid:{},
      level:{},
      activity_number:{},
      activity:{},
      description:{},
      type:{},
      input:{},
      output:{},
      task:{},
      executor:{},
      stage:{},
      tool:{},
      method:{},

    }
  }).on('success.form.fv',function(e){
      // Prevent form submission
      e.preventDefault();
      var $form=$(e.target);
      var data=$form.serializeObject();
      // 表单reset
      var add=$form.attr("data-add");
      var index=$form.attr("data-index")==null?-1:$form.attr("data-index");
      if(add=="true"){
        index++;
      }
      var action=(add=="true"?"insertRow":"updateRow");
      if(data._id==""||data._id==null){
        delete data._id;
      }
      if(data.pid==""||data.pid==null){
        delete data.pid;
      }
      $.post("/activity/edit",data).done(function(res){
        // var data=JSON.parse(data);
        if(res!=null){
          $table.bootstrapTable(action,{index:index,row:res});
          $modal.modal('hide');
          $form.formValidation('resetForm', true);
        }
      })
      
    })
